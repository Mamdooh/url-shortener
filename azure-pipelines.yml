trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**
      - resources/**
      - routes/**
      - config/**
      - public/**

pool: azure-vm-pool

steps:
- script: |
    cd /home/azureuser/url-shortener
    git fetch origin main
    git checkout main
    git reset --hard origin/main
    git fetch --tags
    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0")
    MAJOR_MINOR=${LATEST_TAG#v}
    PATCH=$(git rev-list ${LATEST_TAG}..HEAD --count 2>/dev/null || echo "0")
    SHORT_SHA=$(git rev-parse --short HEAD)
    VERSION="${MAJOR_MINOR}.${PATCH}"
    echo "<?php" > config/version.php
    echo "return [" >> config/version.php
    echo "    'version' => '${VERSION}'," >> config/version.php
    echo "    'build' => '${PATCH}'," >> config/version.php
    echo "    'commit' => '${SHORT_SHA}'," >> config/version.php
    echo "    'environment' => 'production'," >> config/version.php
    echo "];" >> config/version.php
    echo "Deploying version ${VERSION}"
    docker cp app/. url-shortener_app_1:/var/www/html/app/
    docker cp resources/. url-shortener_app_1:/var/www/html/resources/
    docker cp routes/. url-shortener_app_1:/var/www/html/routes/
    docker cp config/. url-shortener_app_1:/var/www/html/config/
    docker cp public/. url-shortener_app_1:/var/www/html/public/
    docker exec url-shortener_app_1 php artisan view:clear
    docker exec url-shortener_app_1 php artisan config:clear
    docker exec url-shortener_app_1 php artisan cache:clear
  displayName: Deploy to Azure