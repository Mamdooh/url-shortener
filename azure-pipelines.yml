trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'app/**'
      - 'resources/**'
      - 'routes/**'
      - 'config/**'
      - 'public/**'
      - 'Dockerfile'
      - 'docker-compose.azure.yml'
      - 'nginx.conf'

pool: azure-vm-pool

steps:
  - script: |
      cd /home/azureuser/url-shortener
      git pull origin main
      
      # Generate version file
      BUILD_NUM=$(git rev-list --count HEAD)
      SHORT_SHA=$(git rev-parse --short HEAD)
      VERSION="1.0.${BUILD_NUM}"
      
      cat > config/version.php << EOF
      <?php

      return [
          'version' => '${VERSION}',
          'build' => '${BUILD_NUM}',
          'commit' => '${SHORT_SHA}',
          'environment' => 'production',
      ];
      EOF
      
      echo "Deploying version ${VERSION}"
      
      # Using Azure Pipeline variables for secrets
      cat > .env << EOF
      APP_KEY=base64:v9JqkGrOKfCxinQBvcU7O2fIhmKIbYSBg6XnE/na6OY=
      DB_PASSWORD=Str0ngP@ss2024!
            APP_KEY=$(APP_KEY)
      APP_ENV=production
      APP_DEBUG=false
      DB_CONNECTION=mysql
      DB_HOST=db
      DB_PORT=3306
      DB_DATABASE=url_shortener
      DB_USERNAME=root
      DB_PASSWORD=$(DB_PASSWORD)
      EOF
      
      docker-compose -f docker-compose.azure.yml down
      docker-compose -f docker-compose.azure.yml up -d --build
    displayName: 'Deploy to Azure'
