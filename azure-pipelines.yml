trigger:
  branches:
    include:
      - main
  paths:
    include:
      - app/**
      - resources/**
      - routes/**
      - config/**
      - public/**
      - Dockerfile
      - docker-compose.azure.yml
      - nginx.conf

pool: azure-vm-pool

steps:
- script: |
    cd /home/azureuser/url-shortener
    git pull origin main
    BUILD_NUM=$(git rev-list --count HEAD)
    SHORT_SHA=$(git rev-parse --short HEAD)
    VERSION="1.0.${BUILD_NUM}"
    echo "<?php" > config/version.php
    echo "return [" >> config/version.php
    echo "    'version' => '${VERSION}'," >> config/version.php
    echo "    'build' => '${BUILD_NUM}'," >> config/version.php
    echo "    'commit' => '${SHORT_SHA}'," >> config/version.php
    echo "    'environment' => 'production'," >> config/version.php
    echo "];" >> config/version.php
    echo "Deploying version ${VERSION}"
    echo "APP_KEY=base64:v9JqkGrOKfCxinQBvcU7O2fIhmKIbYSBg6XnE/na6OY=" > .env
    echo "DB_PASSWORD=Str0ngP@ss2024!" >> .env
    docker-compose -f docker-compose.azure.yml down
    docker-compose -f docker-compose.azure.yml up -d --build
  displayName: Deploy to Azure